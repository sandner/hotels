<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel AI Finder 2000</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            /* padding: 20px; Remove padding from body, will add to appContainer */
            background-color: #f4f4f4;
            /* display: flex; flex-direction: column; align-items: center; Removed for new layout */
            min-height: 100vh;
            box-sizing: border-box;
        }
        #appContainer {
            display: flex; 
            flex-direction: column; /* Stack header and content */
            width: 100%;
            max-width: 1400px; /* Adjust for desired overall width */
            margin: 0 auto; /* Center the container */
            padding: 20px;
            box-sizing: border-box;
            min-height: calc(100vh - 40px); /* Try to make app container use most of viewport height */
        }
        #headerArea {
            width: 100%;
            margin-bottom: 20px; /* Space below header */
        }
        #contentArea {
            display: flex;
            flex-direction: row;
            gap: 20px; /* Space between left and right columns */
            flex-grow: 1; /* Allow content area to fill vertical space */
            width: 100%;
        }
        #leftColumn {
            flex: 1; /* Chat column - adjust ratio as needed */
            display: flex;
            flex-direction: column;
            /* max-width: 450px; /* Optional: if you want to cap chat width */
        }
        #rightColumn {
            flex: 2; /* Criteria/Results column - wider */
            display: flex;
            flex-direction: column;
            gap: 20px; /* Space between panels in the right column */
        }
        .chat-container {
            width: 100%;
            /* max-width: 600px; Removed, now uses column width */
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            /* Adjust height to fill available space in the column, considering title */
            /* height: calc(100vh - 120px); Replaced with max-height for "completely visible" */
            /* min-height: 500px; /* Ensure a reasonable minimum chat height */
            max-height: 70vh; /* Adjust as needed, e.g., 600px or 650px */
            /* max-width: none; /* Allow it to fill the column width - this is default for width:100% */
        }
        /* Style for the new main title */
        #mainTitle {
            font-size: 2.2em;
            color: #333;
            margin-bottom: 20px;
            font-weight: bold;
        }
        /* Styles for the API toggle switch */
        .api-toggle-container {
            margin-bottom: 15px; /* Space below the toggle */
            font-size: 0.9em;
        }
        .api-toggle-container label {
            margin-left: 5px;
        }
        #chatLog {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f9f9f9;
            border-bottom: 1px solid #eee; /* Separator from input area */
        }
        #chatLog div {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 75%;
            word-wrap: break-word;
            line-height: 1.4;
        }
        .user-message {
            background-color: #007bff;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 3px;
        }
        .server-response {
            background-color: #e9e9eb;
            color: #333;
            margin-right: auto;
            border-bottom-left-radius: 3px;
            white-space: pre-wrap; /* To respect newlines and spaces in server response */
        }
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            margin-right: auto;
            border-bottom-left-radius: 3px;
        }
        .input-area {
            display: flex;
            padding: 15px;
            background-color: #fff; /* Ensure it's on top of chatLog background */
            border-top: 1px solid #ddd; /* Added for better separation */
            border-radius: 0 0 8px 8px; /* Match container rounding */
        }
        #messageInput {
            flex-grow: 1;
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-radius: 20px;
            margin-right: 10px;
            font-size: 16px;
        }
        #sendButton {
            padding: 10px 20px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        #sendButton:hover:not(:disabled) {
            background-color: #0056b3;
        }
        #sendButton:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        /* Styles for structured server response */
        .server-response.structured-response {
            background-color: #f0f4f8; /* Slightly different background for structured */
            padding: 15px; /* More padding for structured content */
            border-left: 4px solid #4a90e2; /* Accent border */
            text-align: left; /* Ensure text aligns left */
            white-space: normal; /* Override pre-wrap for structured content */
        }
        .response-section {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #dce4ec;
        }
        .response-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .response-section h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 1.1em;
        }
        .response-section h5 {
            margin-top: 10px; /* Added top margin for h5 */
            margin-bottom: 5px;
            color: #34495e;
            font-size: 1em;
        }
        .message-to-user {
            font-style: italic;
            background-color: #e7f3fe;
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 10px; /* Added margin */
        }
        .criteria-used p, .hotel-card p, .assumptions-made ul, .questions-for-user ul, .suggestions-for-user ul {
            margin: 5px 0;
            font-size: 0.95em;
        }
        .criteria-used strong, .hotel-card strong { /* Target strong tags within these specifically */
            color: #555;
        }
        .hotel-card {
            background-color: #ffffff;
            border: 1px solid #dfe6ee;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .hotel-card h5 { /* Hotel name */
            color: #007bff; 
        }
        .response-section ul {
            list-style-type: disc;
            padding-left: 20px;
            margin-top: 5px;
        }
        .response-section li {
            margin-bottom: 4px;
        }
        .response-section a {
            color: #007bff;
            text-decoration: none;
        }
        .response-section a:hover {
            text-decoration: underline;
        }

        /* Ensure general server-response for non-structured text is still good */
        #chatLog .server-response:not(.structured-response) {
            /* Styles from before, ensuring they apply if not structured */
            background-color: #e9e9eb;
            color: #333;
            margin-right: auto;
            border-bottom-left-radius: 3px;
            white-space: pre-wrap;
            padding: 8px 12px; /* Original padding */
        }
        .detailed-log-container {
            width: 100%;
            max-width: 600px;
            margin-top: 20px; /* Space above the detailed log */
            background-color: #2c3e50; /* Darker background for contrast */
            color: #ecf0f1; /* Light text color */
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 8px;
            padding: 10px;
            font-family: 'Courier New', Courier, monospace; /* Monospace for logs */
            font-size: 0.85em;
            max-height: 200px; /* Max height before scrolling */
            overflow-y: auto;
        }
        /* .info-panels-container is removed; .info-panel is now directly in #rightColumn */
        .info-panel {
            width: 100%;
            /* max-width: 600px; Removed, will take width of right column */
            /* margin-top: 20px; Removed, gap in #rightColumn handles spacing */
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .info-panel h2 {
            margin-top: 0;
            color: #333;
            font-size: 1.2em;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <div id="appContainer">
        <div id="headerArea">
            <h1 id="mainTitle">Hotel AI Finder</h1>
            <div class="api-toggle-container">
                <input type="checkbox" id="apiToggle">
                <label for="apiToggle">Use Test API Endpoint</label>
            </div>
        </div>
        <div id="contentArea">
            <div id="leftColumn">
                <div class="chat-container">
                    <!-- The h1 "Chat Service" is removed from here -->
                    <div id="chatLog"></div>
                    <div class="input-area">
                        <input type="text" id="messageInput" placeholder="Type your message here...">
                        <button id="sendButton">Send</button>
                    </div>
                </div>
            </div>
            <div id="rightColumn">
                <div id="criteriaDisplayArea" class="info-panel">
                    <h2>Current Search Criteria</h2>
                    <!-- Criteria will be injected here by JavaScript -->
                </div>
                <div id="hotelsDisplayArea" class="info-panel">
                    <h2>Suggested Hotels</h2>
                    <!-- Suggested hotels will be injected here by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <div class="detailed-log-container" id="detailedLog">
        <div><strong>Detailed Event Log:</strong></div>
    </div>

    <script>
        const chatLog = document.getElementById('chatLog');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const detailedLog = document.getElementById('detailedLog');
        const criteriaDisplayArea = document.getElementById('criteriaDisplayArea');
        const hotelsDisplayArea = document.getElementById('hotelsDisplayArea');
        const apiToggle = document.getElementById('apiToggle');
        const PROD_API_URL = 'https://uweuweuwe.app.n8n.cloud/webhook/0b310ac9-05d6-4569-97c0-8ba2b590d8c5';
        const TEST_API_URL = 'https://uweuweuwe.app.n8n.cloud/webhook-test/0b310ac9-05d6-4569-97c0-8ba2b590d8c5';
        let sessionId = '';

        function generateSessionId() {
            return `session_${Date.now()}_${Math.random().toString(36).substring(2, 15)}`;
        }

        // --- Logging Functions ---
        
        function appendToLog(message, className) {
            const messageElement = document.createElement('div');
            messageElement.classList.add(className);
            messageElement.textContent = message; // Using textContent for security
            
            chatLog.appendChild(messageElement);
            chatLog.scrollTop = chatLog.scrollHeight; // Auto-scroll to the bottom
        }

        function appendToDetailedLog(message) {
            const logEntry = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();
            logEntry.textContent = `[${timestamp}] ${message}`;
            detailedLog.appendChild(logEntry);
            detailedLog.scrollTop = detailedLog.scrollHeight; // Auto-scroll to bottom
        }

        // --- Helper functions for creating structured response elements ---

        function createKeyValueP(label, value, isHTML = false) {
            const p = document.createElement('p');
            const strong = document.createElement('strong');
            strong.textContent = label + ' ';
            p.appendChild(strong);
            if (isHTML) {
                const span = document.createElement('span');
                span.innerHTML = value;
                p.appendChild(span);
            } else {
                p.appendChild(document.createTextNode(value));
            }
            return p;
        }

        function createListElement(items, titleText, listClass = '') {
            const div = document.createElement('div');
            if (listClass) div.classList.add(listClass);

            const title = document.createElement('h5');
            title.textContent = titleText;
            div.appendChild(title);
            
            const ul = document.createElement('ul');
            items.forEach(itemText => {
                const li = document.createElement('li');
                li.textContent = itemText;
                ul.appendChild(li);
            });
            div.appendChild(ul);
            return div;
        }

        function createSearchContextElement(context) {
            const section = document.createElement('div');
            section.classList.add('response-section', 'search-context');
            // This h4 might be redundant if the panel has its own title, or could be "Status Update"
            // section.appendChild(document.createElement('h4')).textContent = 'Context'; 

            if (context.messageToUser) {
                const p = document.createElement('p');
                p.classList.add('message-to-user');
                p.innerHTML = `${context.messageToUser.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}`;
                section.appendChild(p);
            }
            if (context.status) section.appendChild(createKeyValueP('Status:', context.status));

            if (context.assumptionsMade && context.assumptionsMade.length > 0) {
                section.appendChild(createListElement(context.assumptionsMade, 'Assumptions Made:', 'assumptions-made'));
            }
            return section;
        }

        function renderCriteriaToPanel(criteriaUsedData, panelElement) {
            panelElement.innerHTML = '<h2>Current Search Criteria</h2>'; // Reset panel with title
            if (!criteriaUsedData || Object.keys(criteriaUsedData).length === 0) {
                panelElement.appendChild(document.createElement('p')).textContent = 'No specific criteria defined yet.';
                return;
            }

            const criteriaDiv = document.createElement('div');
            criteriaDiv.classList.add('criteria-used'); // Keep class for potential styling
            
            if (criteriaUsedData.destination) criteriaDiv.appendChild(createKeyValueP('Destination:', criteriaUsedData.destination));
            if (criteriaUsedData.dates) {
                let dateStr = '';
                if (criteriaUsedData.dates.checkIn) dateStr += `Check-in: ${criteriaUsedData.dates.checkIn}`;
                if (criteriaUsedData.dates.checkOut) dateStr += `${dateStr ? ', ' : ''}Check-out: ${criteriaUsedData.dates.checkOut}`;
                if (dateStr) criteriaDiv.appendChild(createKeyValueP('Dates:', dateStr || 'Not specified'));
            }
            if (criteriaUsedData.guests) {
                let guestStr = '';
                if (criteriaUsedData.guests.adults !== null) guestStr += `${criteriaUsedData.guests.adults} adults`;
                if (criteriaUsedData.guests.children !== null) guestStr += `${guestStr ? ', ' : ''}${criteriaUsedData.guests.children} children`;
                if (guestStr) criteriaDiv.appendChild(createKeyValueP('Guests:', guestStr || 'Not specified'));
            }
            if (criteriaUsedData.preferences && criteriaUsedData.preferences.length > 0) {
                criteriaDiv.appendChild(createKeyValueP('Preferences:', criteriaUsedData.preferences.join(', ')));
            }
            if (criteriaUsedData.moodExperience) {
                criteriaDiv.appendChild(createKeyValueP('Mood/Experience:', criteriaUsedData.moodExperience));
            }
            panelElement.appendChild(criteriaDiv);
        }

        function createSuggestedHotelsElement(hotels) {
            const section = document.createElement('div');
            // The H2 title is now part of the panel's static HTML or added by render function

            hotels.forEach(hotel => {
                const card = document.createElement('div');
                card.classList.add('hotel-card');
                card.appendChild(document.createElement('h5')).textContent = hotel.name || 'Unnamed Hotel';

                if (hotel.matchReason) card.appendChild(createKeyValueP('Match Reason:', hotel.matchReason));
                if (hotel.ratings) {
                    let ratingsStr = [];
                    if (hotel.ratings.bookingCom) ratingsStr.push(`Booking.com: ${hotel.ratings.bookingCom}`);
                    if (hotel.ratings.google) ratingsStr.push(`Google: ${hotel.ratings.google}`);
                    if (ratingsStr.length > 0) card.appendChild(createKeyValueP('Ratings:', ratingsStr.join(', ')));
                }
                if (hotel.travelerSentiment) card.appendChild(createKeyValueP('Traveler Sentiment:', hotel.travelerSentiment));
                if (hotel.links) {
                    const linksP = document.createElement('p');
                    linksP.appendChild(document.createElement('strong')).textContent = 'Links: ';
                    const links = [];
                    if (hotel.links.officialWebsite) links.push(`<a href="${hotel.links.officialWebsite}" target="_blank">Official Website</a>`);
                    if (hotel.links.bookingComSearch) links.push(`<a href="${hotel.links.bookingComSearch}" target="_blank">Booking.com Search</a>`);
                    linksP.innerHTML += links.join(' | ');
                    if (links.length > 0) card.appendChild(linksP);
                }
                section.appendChild(card);
            });
            return section;
        }

        function createFollowUpElement(followUpData) {
            const section = document.createElement('div');
            section.classList.add('response-section', 'follow-up');
            section.appendChild(document.createElement('h4')).textContent = 'Next Steps';
            if (followUpData.questionsForUser && followUpData.questionsForUser.length > 0) section.appendChild(createListElement(followUpData.questionsForUser, 'Questions for you:', 'questions-for-user'));
            if (followUpData.suggestionsForUser && followUpData.suggestionsForUser.length > 0) section.appendChild(createListElement(followUpData.suggestionsForUser, 'Suggestions for you:', 'suggestions-for-user'));
            return section;
        }

        function displayStructuredServerResponse(data) {
            const chatMessageElement = document.createElement('div');
            chatMessageElement.classList.add('server-response', 'structured-response'); 

            // Clear previous content from external panels
            criteriaDisplayArea.innerHTML = '<h2>Current Search Criteria</h2>'; // Reset with title
            hotelsDisplayArea.innerHTML = '<h2>Suggested Hotels</h2>'; // Reset with title

            if (data.Answer) {
                const answer = data.Answer;

                if (answer.searchContext) {
                    // Append chat-relevant parts of searchContext to the chat message
                    chatMessageElement.appendChild(createSearchContextElement(answer.searchContext));
                    // Render criteriaUsed to its dedicated panel
                    if (answer.searchContext.criteriaUsed) {
                        renderCriteriaToPanel(answer.searchContext.criteriaUsed, criteriaDisplayArea);
                    } else {
                         criteriaDisplayArea.appendChild(document.createElement('p')).textContent = 'No criteria specified in this update.';
                    }
                }

                if (answer.suggestedHotels && answer.suggestedHotels.length > 0) {
                    hotelsDisplayArea.appendChild(createSuggestedHotelsElement(answer.suggestedHotels));
                } else {
                    hotelsDisplayArea.appendChild(document.createElement('p')).textContent = 'No hotel suggestions in this update.';
                }

                if (answer.followUp) {
                    chatMessageElement.appendChild(createFollowUpElement(answer.followUp));
                }

                // Only append to chatLog if there's content for it
                if (chatMessageElement.hasChildNodes()) {
                    chatLog.appendChild(chatMessageElement);
                }
            } else {
                const pre = document.createElement('pre');
                pre.textContent = JSON.stringify(data, null, 2);
                chatMessageElement.appendChild(pre);
                appendToDetailedLog('Server response JSON did not contain "Answer" key. Displaying raw JSON.');
                chatLog.appendChild(chatMessageElement); // Append even if it's just the raw JSON
            }
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        // --- Main Chat Logic ---

        async function sendMessage() {
            const messageText = messageInput.value.trim();
            if (!messageText) {
                return; // Don't send empty messages
            }

            appendToLog(`You: ${messageText}`, 'user-message');
            appendToDetailedLog(`User message: "${messageText}"`);
            messageInput.value = ''; // Clear input field
            sendButton.disabled = true; // Disable button during request
            appendToDetailedLog(`Send button disabled. Preparing to send message with Session ID: ${sessionId}`);

            try {
                const currentApiUrl = apiToggle.checked ? TEST_API_URL : PROD_API_URL;
                appendToDetailedLog(`Using API URL: ${currentApiUrl}`);
                // Construct URL with query parameters for GET request
                const params = new URLSearchParams({
                    message: messageText,
                    sessionId: sessionId
                });
                const urlWithParams = `${currentApiUrl}?${params.toString()}`;
                appendToDetailedLog(`Sending GET request to: ${urlWithParams}`);

                const response = await fetch(urlWithParams, {
                    method: 'GET'
                    // No 'headers' like 'Content-Type' needed for GET body
                    // No 'body' for GET requests
                    /* Original POST body:
                    body: JSON.stringify({
                        message: messageText,
                        sessionId: sessionId // Include sessionId in the request
                    }) */
                });

                appendToDetailedLog(`Received response. Status: ${response.status} ${response.statusText}`);
                const responseDataText = await response.text(); // Get response as raw text first
                appendToDetailedLog(`Raw server response: ${responseDataText.substring(0, 200)}${responseDataText.length > 200 ? '...' : ''}`);

                if (response.ok) {
                    try {
                        const jsonData = JSON.parse(responseDataText);
                        // Check if it's the specific structured response we expect
                        if (jsonData && typeof jsonData === 'object' && jsonData.Answer) {
                            appendToDetailedLog('Processing structured "Answer" response.');
                            displayStructuredServerResponse(jsonData); // Use the new display function
                        } else {
                            // It's JSON, but not the "Answer" structure, or not an object. Display as formatted text.
                            appendToDetailedLog('Response is JSON but not the expected "Answer" structure. Displaying as formatted text.');
                            const formattedJson = JSON.stringify(jsonData, null, 2);
                            appendToLog(`Server: ${formattedJson}`, 'server-response');
                        }
                    } catch (e) {
                        // Not valid JSON. Display as plain text.
                        appendToDetailedLog('Server response is not valid JSON. Displaying as plain text.');
                        appendToLog(`Server: ${responseDataText}`, 'server-response');
                    }
                } else {
                    appendToLog(`Error: ${response.status} ${response.statusText}. Server response: ${responseDataText}`, 'error-message');
                    appendToDetailedLog(`HTTP Error ${response.status}: ${response.statusText}. Server data: ${responseDataText}`);
                }
            } catch (error) {
                console.error('Fetch error:', error);
                appendToLog(`Network Error: ${error.message}. Please check the console for more details.`, 'error-message');
                appendToDetailedLog(`Network/Fetch Error: ${error.message}`);
            } finally {
                sendButton.disabled = false; // Re-enable button
                messageInput.focus(); // Focus back on input
            }
        }

        // --- Event Listeners & Initialization ---

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent default form submission if it were in a form
                sendMessage();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            sessionId = generateSessionId();
            const initialApiUrl = apiToggle.checked ? TEST_API_URL : PROD_API_URL;
            appendToDetailedLog(`Chat initialized. Session ID: ${sessionId}. Default API: ${initialApiUrl}`);
            messageInput.focus(); // Initial focus on the input field
        });
    </script>

</body>
</html>